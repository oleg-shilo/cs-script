@page "/"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using System.Diagnostics
@using wdbg.cs_script
@using System.Text.Json
@inject IJSRuntime JS
@inject NavigationManager Navigation

@* https://skmedix.github.io/ikonli-java-8/cheat-sheet-openiconic.html *@

<PageTitle>CodeMirror Editor</PageTitle>

<div class="@($"theme-{Editor.SelectedTheme}")">
    <div class="top-row px-4 d-flex justify-content-between align-items-center" id="top-row-panel">
        <div class="d-flex align-items-center gap-2">
            <button title="Load the specified script to the editor/debugger" class="btn btn-outline-secondary btn-sm" style="margin-left:-15px;" @onclick="LoadScriptFromServer">
                Load Script
            </button>
            <input type="text"
                   @bind="Editor.LoadedScript"
                   @ref="fileNameInputRef"
                   @oninput="AutoSizeFileNameInput"
                   placeholder="Server file path..."
                   class="theme-input @($"theme-input-{Editor.SelectedTheme}")"
                   style="min-width: 320px; max-width: 100%; display: inline-block;" />
            <span style="width:5px;margin-left:-18px;margin-top:-5px;">
                @if (Document?.IsModified == true)
                {
                    <span style="color: #dc3545; font-weight: bold;">*</span>
                }
            </span>
        </div>
        <div class="d-flex align-items-center ">
            
            <div class="d-flex align-items-center ms-3 debug-commands" style="gap: 0.5rem;">
                <button class="btn btn-run btn-sm btn-nav" title="Save the loaded document at it's original location (Ctrl+S)" @onclick="() => SaveToFileOnServer(false)">
                    <svg width="20" height="20" viewBox="0 0 512 512" 
                        xmlns="http://www.w3.org/2000/svg" 
                        xml:space="preserve" 
                        style="transform: scale(1.7); margin: 0 auto; display: block;">
                            <path 
                                fill="currentColor" 
                                fill-rule="evenodd" 
                                clip-rule="evenodd" 
                                d="M439.965,0H1.108v512h509.784V72.407L439.965,0z M74.251,73.143H293.68v110.823H74.251V73.143z M437.749,441.074H72.035 V257.108h365.714V441.074z M437.749,183.965h-70.926V73.143h42.625l28.302,29.339V183.965z"/>
                    </svg>
                </button>
                <span class="group-separator" />
                @if (OperatingSystem.IsWindows())
                {
                    <button class="btn btn-run btn-sm btn-nav" id="open-in-vs" title="Open in Visual Studio" @onclick="() => OpenInVS()">
                        <svg width="20" height="20" viewBox="0 0 24 24" 
                        xmlns="http://www.w3.org/2000/svg" 
                        xml:space="preserve" 
                        style="transform: scale(2.03); margin: 0 auto; display: block;">
                            <path fill="currentColor" 
                            fill-rule="evenodd" 
                            clip-rule="evenodd" 
                            d="m21.292 4.103-4.118-1.98a1.232 1.232 0 0 0-.489-.121L16.643 2h-.036a1.248 1.248 0 0 0-.862.364L7.869 9.55 4.437 6.947a.83.83 0 0 0-1.064.047L2.272 7.995A.83.83 0 0 0 2 8.607v.004c0 .225.09.451.272.616l2.976 2.715-2.976 2.715a.834.834 0 0 0 .001 1.232l1.101 1.001a.828.828 0 0 0 1.065.047l3.432-2.603 7.876 7.186a1.24 1.24 0 0 0 .764.358l.012.001c.018.002.037.002.055.003.025.001.05.002.075.001l.027-.001c.169-.006.337-.045.496-.122l4.118-1.98c.431-.207.706-.645.706-1.125V5.229c0-.481-.275-.918-.708-1.126zm-4.298 12.369-5.972-4.531 5.972-4.531v9.062z"/>
                        </svg>
                    </button>
                }
                <button class="btn btn-run btn-sm btn-nav" title="Go To Definition (Ctrl+F12)" @onclick="() => GoToDefinition()">
                    <span class="oi oi-account-login"></span>
                </button>
                <button class="btn btn-run btn-sm btn-nav" title="Go to next error (file location) from the output panel (F4)" @onclick="() => GoToNextCompileError()">
                    <span class="oi oi-fullscreen-exit rotate45"></span>
                </button>
                <span class="group-separator" />
                <button class="btn btn-run btn-sm btn-run-check " title="Check Script Syntax (F4)" @onclick="() => OnSyntaxCheckClicked()" disabled="@(!syntaxCheckAvailable)">
                    <span class="oi oi-check"></span>
                </button>
                @if (UserSession?.IsLocalClient == true)
                {
                    <button class="btn btn-run btn-run-detached btn-sm" title="Start in the Terminal" @onclick="() => OnStartExternalClicked()" disabled="@(!startDetachedlAvailable)">
                        <span class="oi oi-terminal"></span>
                    </button>
                }
                <button class="btn btn-run btn-run-detached btn-sm" title="Start Without Debugging" @onclick="() => Start(breakAtStart: false, detached: true)" disabled="@(!startDetachedlAvailable)">
                    <span class="oi oi-chevron-right"></span>
                </button>
                <span class="group-separator" />
                <button class="btn btn-run btn-sm" title="Start/Resume (F5)" @onclick="OnStartClicked" disabled="@(!startAvailable)">
                    <span class="oi oi-caret-right"></span>
                </button>
                <button class="btn btn-run btn-sm" title="Step Over (F10)" @onclick="OnStepOverClicked" disabled="@(!stepCommandsAvailable)">
                    <span class="oi oi-data-transfer-download rotate-90" title="Step Over"></span>
                </button>
                <button class="btn btn-run btn-sm" title="StepInto (F11)" @onclick="OnStepIntoClicked" disabled="@(!stepCommandsAvailable)">
                    <span class="oi oi-data-transfer-download" title="Step Into"></span>
                </button>
                <button class="btn btn-pause btn-sm" title="Pause" @onclick="OnPauseClicked" disabled="@(!pauseAvailable)">
                    <span class="oi oi-media-pause"></span>
                </button>
                <button class="btn btn-stop btn-sm" title="Stop (Shift+F5)" @onclick="OnStopClicked" disabled="@(!stopAvailable)">
                    <span class="oi oi-media-stop"></span>
                </button>
                <span hidden class="oi oi-caret-bottom" style="vertical-align: middle; font-size: 0.7em;"></span>
            </div>
            <div class="d-flex align-items-center ms-3 " style="gap: 0.5rem;">
                <label>Theme: </label>
                <select @onchange="OnThemeChanged" value="@Editor.SelectedTheme">
                    @foreach (var theme in Editor.Themes)
                    {
                        <option value="@theme">@theme</option>
                    }
                </select>
                @*  <a href="https://github.com/oleg-shilo/cs-script/wiki/WDBG" class="mb-2 ms-3" style="margin-left:20px" target="_blank">About</a> *@
                @if ((UserSession?.IsLocalClient == true))
                {
                    <span title="This browser is running on&#10;the same machine as the server." class="badge bg-success">Local Client</span>
                }
                else
                {
                    <span title="This browser is connected to&#10;the debugger server remotely." class="badge bg-secondary">Remote Client</span>
                }
            </div>

        </div>
    </div>
</div>

<div class="main-content">
    <div class="split-container">
        <div class="split-panel left-panel">
            <div class="left-vertical-container">
                <div class="left-top-panel">
                    <div id="editor"></div>
                </div>
                <div class="left-horizontal-resizer" @onmousedown="StartLeftHorizontalResize"></div>
                <div class="left-bottom-panel">
                    @if (DebugSession?.IsScriptExecutionInProgress == true)
                    {
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <input type="text"
                                   class="cli-input @($"theme-input-{Editor.SelectedTheme}")"
                                   placeholder="Terminal input goes here..."
                                   @bind="userCliInput"
                                   @bind:event="oninput"
                                   @onkeydown="OnCliInputKeyDown" />
                            <button class="clear-bottom-panel-btn" @onclick="ClearOutput" title="Clear panel" style="flex: none;">
                                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M10 12.6l.7.7 1.6-1.6 1.6 1.6.8-.7L13 11l1.7-1.6-.8-.8-1.6 1.7-1.6-1.7-.7.8 1.6 1.6-1.6 1.6zM1 4h14V3H1v1zm0 3h14V6H1v1zm8 2.5V9H1v1h8v-.5zM9 13v-1H1v1h8z" /></svg>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <button class="clear-bottom-panel-btn" @onclick="ClearOutput" title="Clear panel" style="flex: none;">
                                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M10 12.6l.7.7 1.6-1.6 1.6 1.6.8-.7L13 11l1.7-1.6-.8-.8-1.6 1.7-1.6-1.7-.7.8 1.6 1.6-1.6 1.6zM1 4h14V3H1v1zm0 3h14V6H1v1zm8 2.5V9H1v1h8v-.5zM9 13v-1H1v1h8z" /></svg>
                            </button>
                        </div>
                    }
                    <div class="bottom-panel-output">

                        <ul>
                            @for (int i = 0; i < Editor.Output.Count; i++)
                            {
                                var selected = i == currentOutputIndex;
                                var selectedIndex = i;

                                <li class="output-line @(selected ? "output-line-highlight" : null)"
                                    @onclick="() => OnOutputLineClick(selectedIndex)">
                                    @Editor.Output[i]
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="split-resizer" @onmousedown="StartResize"></div>
        <div class="split-panel right-panel">
            @* <div style="font-family:monospace;white-space:pre-wrap;background:#f5f5f5;padding:4px 8px;border-radius:4px;"> *@

            <div class="locals-watch-tabs">
                <div class="tab-header">
                    <button class="tab-btn @(selectedTab == 0 ? "active" : "")" @onclick="() => SelectTab(0)">Locals</button>
                    <button class="tab-btn @(selectedTab == 1 ? "active" : "")" @onclick="() => SelectTab(1)">Watch</button>
                </div>
                <div class="tab-content">
                    @if (selectedTab == 0)
                    {
                        <div class="locals-table-container">
                            <table class="table table-sm table-bordered locals-table watch-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Value</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Variables.Count; i++)
                                    {
                                        var variable = Variables[i];
                                        var index = i;
                                        <tr class="@(selectedLocalIndex == index ? "selected-row" : null)"
                                            @onclick="(() => OnLocalsItemSelected(index))">
                                            <td title="@(variable.Name)">@(string.IsNullOrEmpty(variable.Name) ? "\u00A0" : variable.Name)</td>
                                            <td>@(string.IsNullOrEmpty(variable.Value) ? "\u00A0" : variable.DisplayValue)</td>
                                            <td title="@(variable.Type)">@(string.IsNullOrEmpty(variable.Type) ? "\u00A0" : variable.Type)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <div class="locals-value-label" style="margin-top:12px; margin-bottom:4px;">
                                Selected Object:
                                <span style="font-weight:normal; color:#888; margin-left:8px;">
                                    @selectedLocalName
                                </span>
                            </div>

                            <textarea class="locals-value-textarea" readonly
                                      value="@selectedLocalValue"
                                      @oncontextmenu="ShowLocalsContextMenu"
                                      @oncontextmenu:preventDefault> </textarea>
                        </div>
                    }
                    else if (selectedTab == 1)
                    {
                        <div class="locals-table-container">
                            <div class="watch-add-bar" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                <input class="watch-input-textarea"
                                       style="flex:1; min-width:0;"
                                       placeholder="Enter watch expression..."
                                       @bind="newWatchExpression"
                                       @bind:event="oninput"
                                       @onkeydown="OnWatchInputKeyDown" />
                                <button class="btn btn-sm btn-primary" @onclick="AddWatchVariable">Add</button>
                            </div>
                            <table class="table table-sm table-bordered locals-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Value</th>
                                        <th>Type</th>
                                        <th style="width:32px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < WatchVariables.Count; i++)
                                    {
                                        var variable = WatchVariables[i];
                                        var index = i;
                                        <tr class="@(selectedWatchIndex == index ? "selected-row" : null)"
                                            @onclick="(() => OnWatchItemSelected(index))">
                                            <td title="@(variable.Name)">@(string.IsNullOrEmpty(variable.Name) ? "\u00A0" : variable.Name)</td>
                                            <td>@(string.IsNullOrEmpty(variable.Value) ? "\u00A0" : variable.DisplayValue)</td>
                                            <td title="@(variable.Type)">@(string.IsNullOrEmpty(variable.Type) ? "\u00A0" : variable.Type)</td>

                                            <td style="width:32px">
                                                <button class="watch-remove-btn"
                                                        title="Remove"
                                                        @onclick:stopPropagation="true"
                                                        @onclick="(() => RemoveWatchVariable(index))">
                                                    &times;
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <div class="locals-value-label" style="margin-top:12px; margin-bottom:4px;">
                                Selected Object:
                                <span style="font-weight:normal; color:#888; margin-left:8px;">
                                    @selectedWatchName
                                </span>
                            </div>

                            <textarea class="locals-value-textarea" readonly
                                      value="@selectedWatchValue"
                                      @oncontextmenu="ShowWatchContextMenu"
                                      @oncontextmenu:preventDefault> </textarea>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

<div class="toast-container-bottomright">
    @if (!string.IsNullOrEmpty(Editor?.ToastMessage))
    {
        <div class="toast-message @Editor.ToastType"
             @onclick="Editor.HideToast"
             @onmouseover="Editor.PauseToastTimer"
             @onmouseout="Editor.ResumeToastTimer">
             @foreach (var item in Editor.ToastMessage?.GetLines() ?? [])
             {
                 @item <br />
             }
        </div>
    }
</div>


<ContextMenu Show="showContextMenu"
             X="contextMenuX"
             Y="contextMenuY"
             ValueToCopy="@contextMenuValueToCopy"
             OnClose="HideContextMenu" />

@code {
    string userCliInput = "";

    ElementReference fileNameInputRef;
    int outputPosition = 0;
    List<VariableInfo> Variables = new();

    int selectedTab = 0; // 0 = Locals, 1 = Watch

    List<VariableInfo> WatchVariables = new();

    int selectedLocalIndex = -1;
    int selectedWatchIndex = -1;

    string selectedWatchName => selectedWatchIndex != -1 && WatchVariables.Count > selectedWatchIndex ? WatchVariables[selectedWatchIndex].Name : null;
    string selectedLocalName => selectedLocalIndex != -1 && Variables.Count > selectedLocalIndex ? Variables[selectedLocalIndex].Name : null;

    string selectedWatchValue = "";
    string selectedLocalValue = "";

    bool showContextMenu = false;
    double contextMenuX, contextMenuY;
    string contextMenuValueToCopy = "";

    ValueTask<TValue> js<TValue>(string identifier, params object?[]? args) => JS.InvokeAsync<TValue>(identifier, args);
    ValueTask js(string identifier, params object?[]? args) => JS.InvokeVoidAsync(identifier, args);

    void StateHasChangedSafe() => InvokeAsync(StateHasChanged); // Ensure StateHasChanged is called on the UI thread

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender) await InitPage(); }

    public async Task InitPage()
    {
        ClearLocals();


        (this.UserSession, bool created) = await JS.FindOrCreateUserSessionFor(this);
        this.Document = this.UserSession.Document;
        this.Editor = this.UserSession.Editor;
        this.UIEvents = this.UserSession.UIEvents;
        this.DebugSession = this.UserSession.DebugSession;
        this.Editor.Storage = new Ide.localStorage(JS); // important to pass a freshly initialized copy of JS

        UIEvents.OnChange += StateHasChangedSafe;
        UIEvents.OnDbgChange += DebugStateHasChanged;
        UIEvents.OnObjectValue += DebugObjectStateChanged;

        _ = Tools.Locate()
            .ContinueWith(t =>
            {
                if (t.Result.HasText())
                    Editor.ShowToastInfo(t.Result);
            });

        await Editor.ReadPersistedConfig();
        await js("codemirrorInterop.init", Editor.SelectedCmTheme, DotNetObjectReference.Create(this));
        await js("restoreSplitPositions");
        await js("registerWindowKeyHandlers", DotNetObjectReference.Create(this));

        Navigation.Uri.ParseUriQuery().TryGetValue("script", out var requestedScriptParams);

        // Restore file name and content if available
        var fileToLoad = requestedScriptParams.FirstOrDefault() ?? Editor.LastSessionFileName;
        if (fileToLoad != null)
        {
            Editor.LoadedScript = fileToLoad;

            await LoadScriptFromServer();
            Editor.LastSessionFileName = fileToLoad;
        }

        // This JS checks if the browser is running on localhost or 127.0.0.1
        var hostname = await JS.InvokeAsync<string>("eval", "window.location.hostname");
        UserSession.IsLocalClient = (hostname == "localhost" || hostname == "127.0.0.1");

        UIEvents.NotifyStateChanged();

        // need to call it after the HTML element received the new value triggered by StateHasChanged
        await AutoSizeFileNameInput(null);
    }

    void OnCliInputKeyDown(KeyboardEventArgs e)
    {
        // Only process input if a script is running and StandardInput is available
        if (DebugSession?.RunningScript?.StandardInput == null)
            return;

        // Ignore non-character keys except Enter and Backspace
        if (e.Key.Length == 1)
        {
            try
            {
                DebugSession.RunningScript.StandardInput.Write(e.Key);
            }
            catch { /* Ignore errors from closed process */ }
        }
        else if (e.Key == "Enter")
        {

            try
            {
                DebugSession.RunningScript.StandardInput.Write("\n");
            }
            catch { }
            finally
            {
                userCliInput = "";
                StateHasChanged();
            }
        }
        else if (e.Key == "Backspace")
        {
            // Optionally, send backspace to the process if needed
            // DebugSession.RunningScript.StandardInput.Write("\b");
            // For most CLI, backspace is handled by the terminal, not the process
        }
    }

    public async Task TriggerCompletionSuggestion() { try { await js("codemirrorInterop.triggerCompletion"); } catch (Exception e) { e.Log(); } }
    async Task AutoSizeFileNameInput(ChangeEventArgs e) { try { await js("autoSizeInput", fileNameInputRef); } catch (Exception ex) { ex.Log(); } }
    async Task StartLeftHorizontalResize(MouseEventArgs e) { try { await js("startLeftHorizontalResize"); } catch (Exception ex) { ex.Log(); } }
    async Task<string> GetDocumentContent() { try { return await js<string>("codemirrorInterop.getValue"); } catch (Exception e) { e.Log(); } return ""; }
    async Task SetDocumentContent(string content) { try { await js("codemirrorInterop.setValue", content); } catch (Exception e) { e.Log(); } }
    async Task RenderBreakpoints() { try { await js("codemirrorInterop.setBreakpoints", Document.Breakpoints.ToArray()); } catch (Exception e) { e.Log(); } }
    async Task<int[]> GetBreakpoints() { try { return await js<int[]>("codemirrorInterop.getBreakpoints"); } catch (Exception e) { e.Log(); } return []; }
    async Task<int> GetCaretPosition() { try { return await js<int>("codemirrorInterop.getCaretAbsolutePosition"); } catch (Exception e) { e.Log(); } return -1; }
    async Task<int> GetCaretPosition(int line, int ch) { try { return await js<int>("codemirrorInterop.getCaretAbsolutePosition", line, ch); } catch (Exception e) { e.Log(); } return -1; }
    async Task SetCaretPosition(int position) { try { await js("codemirrorInterop.setCaretAbsolutePosition", position); } catch (Exception e) { e.Log(); } }
    async Task ScrollCurrentLineToView() { try { await js("codemirrorInterop.scrollCurrentLineToView"); } catch (Exception e) { e.Log(); } }
    async Task ScrollLineToView(int line) { try { await js("codemirrorInterop.scrollLineToView", line); } catch (Exception e) { e.Log(); } }
    async Task setCurrentStepLine(int line) { try { await js("codemirrorInterop.setCurrentStepLine", line); } catch (Exception e) { e.Log(); } }
    async Task SetCaretPosition(int line, int lineCh) { try { await js("codemirrorInterop.setCaretPosition", line, lineCh); } catch (Exception e) { e.Log(); } }
    async Task ScrollToAndHighlightLine(int line, int ch) { try { await js("codemirrorInterop.scrollToAndHighlightLine", line, ch); } catch (Exception e) { e.Log(); } }

    async Task OnThemeChanged(ChangeEventArgs e)
    {
        Editor.SelectedTheme = e.Value?.ToString() ?? "light";
        await js("codemirrorInterop.setTheme", Editor.SelectedCmTheme);
    }

    public void OutputScrollToEnd() { try { _ = js("setTimeout", $"document.querySelector('.bottom-panel-output')?.scrollTo(0, 1e6)", 50); } catch (Exception e) { e.Log(); } }

    [JSInvokable]
    public async Task OnEditorChanged()
    {
        Document.IsModified = true;
        UIEvents.NotifyStateChanged();
    }

    [JSInvokable]
    public Task UpdateCaretInfo(string lineText, int line, int ch, int pos)
    {
        Document.CaretLine = line + 1; // 1-based for display
        Document.CaretCh = ch + 1;     // 1-based for display
        Document.CaretPos = pos;     // 0-based for display
        UIEvents.NotifyStateChanged();
        return Task.CompletedTask;
    }

    public bool OnOutputLineClick(int lineIndex)
    {
        string line = Editor.Output[lineIndex];
        currentOutputIndex = lineIndex;

        // Example: D:\dev\spikes\WebCodeEditor\CodeMiro\test.cs(11,5): error CS1001:  Identifier expected
        var match = System.Text.RegularExpressions.Regex.Match(
            line,
            @"^(?<file>.+)\((?<line>\d+),(?<col>\d+)\):.*$"
        );
        if (match.Success)
        {
            var file = match.Groups["file"].Value;
            var lineNum = int.Parse(match.Groups["line"].Value);
            var colNum = int.Parse(match.Groups["col"].Value);

            // Only navigate if the file matches the currently loaded script
            if (file.Equals(Editor.LoadedScript, StringComparison.OrdinalIgnoreCase))
            {
                // CodeMirror is 0-based, so subtract 1
                ScrollToAndHighlightLine(lineNum - 1, colNum - 1);
                return true;
            }
        }
        return false;
    }


    public async Task OnLocalsItemSelected(int index)
    {
        selectedLocalIndex = index;
        selectedLocalValue = null;
        UIEvents.NotifyStateChanged();
        RequestSelectedVariablesInfo(locals: true, watch: false);
    }

    async Task StartResize(MouseEventArgs e) => await js("startSplitResize");

    public void OnWatchItemSelected(int index)
    {
        selectedWatchIndex = index;
        selectedWatchValue = null;
        UIEvents.NotifyStateChanged();
        RequestSelectedVariablesInfo(locals: false, watch: true);
    }

    [JSInvokable] public async Task OnCtrlS() => await SaveToFileOnServer(false);
    [JSInvokable] public async Task OnCtrlE() => await OpenScriptFolder();
    [JSInvokable] public async Task OnCtrlF() => await OnFormatRequest();
    [JSInvokable] public async Task OnF4() => GoToNextCompileError();
    [JSInvokable] public async Task OnF5() => OnStartClicked();
    [JSInvokable] public async Task OnShiftF5() => this.OnStopClicked();
    [JSInvokable] public async Task OnF7() => OnSyntaxCheckClicked();
    [JSInvokable] public async Task OnF9() => await js("codemirrorInterop.toggleBreakpointAtCursor");
    [JSInvokable] public async Task OnShiftF9() => await js("codemirrorInterop.clearAllBreakpoints");
    [JSInvokable] public async Task OnF10() => OnStepOverClicked(null);
    [JSInvokable] public async Task OnF11() => OnStepIntoClicked(null);
    [JSInvokable] public async Task OnCtrlF12() => GoToDefinition();

    [JSInvokable]
    public async Task<string> GetTooltipFor(string text, int line, int charPos)
    {
        var editorText = await GetDocumentContent();
        var caretPosition = await GetCaretPosition(line, charPos);

        var roslynCompatible = editorText.NormalizeLineBreaks(caretPosition);

        var result = Syntaxer.GetTooltip(roslynCompatible.newText, Editor.LoadedScript, roslynCompatible.newOffset);

        if (result == null)
            return null;

        // Example result:
        // 103
        // Method: void Console.WriteLine(string? value) (+ 18 overloads)

        // Return HTML content with a button styled as a hyperlink
        return $@"{(result.GetLines().LastOrDefault())}<br/>" +
               $@"<button onclick='window.goToDefinitionFromTooltip({line}, {charPos}); return false;'
                          style='color: #007bff; text-decoration: underline; cursor: pointer; background: none; border: none; padding: 0; font: inherit; outline: none;'>" +
               "Go To Definition</button>";
    }

    [JSInvokable]
    public async Task GoToDefinitionFromTooltip(int line, int charPos)
    {
        // This method will be called from  when the link is clicked
        await SetCaretPosition(line, charPos);
        GoToDefinition();
    }
    public async void GoToDefinition()
    {
        var editorText = await GetDocumentContent();
        int caretPosition = await GetCaretPosition();

        var roslynCompatible = editorText.NormalizeLineBreaks(caretPosition);

        var result = Syntaxer.Resolve(roslynCompatible.newText, Editor.LoadedScript, roslynCompatible.newOffset)?.GetLines() ?? [];
        if (result.Any())
        {
            try
            {
                var file = result.FirstOrDefault(x => x.StartsWith("file:"))?.Replace("file:", "");
                var line = result.FirstOrDefault(x => x.StartsWith("line:"))?.Replace("line:", "").Trim();
                if (file.HasText() && File.Exists(file))
                {
                    if (file != Editor.LoadedScript)
                    {
                        Editor.ShowExternalFile(file, line.ToInt());
                    }
                    else
                    {
                        var lineNumber = int.Parse(line);
                        ScrollToAndHighlightLine(lineNumber - 1, 0);
                    }
                }
            }
            catch
            {
            }
        }
    }

    public async void OpenInVS()
    {
        try
        {
            if (File.Exists(Editor?.LoadedScript ?? ""))
            {
                Tools.OpenInVs(Editor?.LoadedScript);
                Editor?.ShowToastSuccess("Loading script in VS is triggered.\nYou may be prompted to initialize the VS integration.");
            }
        }
        catch (Exception e)
        {

            Editor?.ShowToastError(e.Message);
        }
    }
    
    public async void ShowReferences()
    {
        var editorText = await GetDocumentContent();
        int caretPosition = await GetCaretPosition();

        var roslynCompatible = editorText.NormalizeLineBreaks(caretPosition);

        var result = Syntaxer.FindReferences(roslynCompatible.newText, Editor.LoadedScript, roslynCompatible.newOffset);

        Editor.Output.Clear();
        Editor.Output.AddRange(result.GetLines());
        StateHasChangedSafe();
    }

    [JSInvokable]
    public async Task OnFormatRequest()
    {
        try
        {
            var editorText = await GetDocumentContent();
            int caretPosition = await GetCaretPosition();

            var roslynCompatible = editorText.NormalizeLineBreaks(caretPosition);

            // Syntaxer.Format uses Roslyn and it always replaces line breaks with the ones specific for the OS
            // so prepare the text with consistent line breaks.

            var formattedCode = Syntaxer.Format(roslynCompatible.newText, Editor.LoadedScript, ref roslynCompatible.newOffset);

            // CodeMirror always work with \n line breaks
            var cmSpecific = formattedCode.NormalizeLineBreaks(roslynCompatible.newOffset, "\n");

            await SetDocumentContent(cmSpecific.newText);
            await SetCaretPosition(cmSpecific.newOffset);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnFormatRequest: {ex.Message}");
            StateHasChangedSafe();
        }
    }

    [JSInvokable]
    public async Task<object[]> OnCompletionRequest(string editorText, int caret)
    {
        try
        {
            var suggestions = Syntaxer.GetCompletions(editorText, Editor.LoadedScript, caret);
            if (!suggestions.HasText())
                return [];

            // <member>\t<member type>|<replacement text>
            // Aggregate(...)\tmethod | Aggregate
            var lines = suggestions.Split(new[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
            var items = lines.Select(x => x.Split(['|', '\t']));
            var maxTextLength = items.Max(x => x[0].Length);

            var suggestionItems = items
                .Select(x => (object)new
                {
                    displayText = $"{x[0].EnsureLength(maxTextLength)}  {x[1].Trim()}",
                    text = x[2].Trim()
                })
                .ToArray();

            return suggestionItems;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnCompletionRequest: {ex.Message}");
            return [];
        }
    }

    void SelectTab(int tab)
    {
        selectedTab = tab;
        StateHasChanged();
    }

    void OnWatchInputKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddWatchVariable();
        }
    }

    void ShowLocalsContextMenu(MouseEventArgs e)
    {
        contextMenuX = e.ClientX;
        contextMenuY = e.ClientY;
        contextMenuValueToCopy = selectedLocalValue;
        showContextMenu = true;
        StateHasChanged();
    }

    void ShowWatchContextMenu(MouseEventArgs e)
    {
        contextMenuX = e.ClientX;
        contextMenuY = e.ClientY;
        contextMenuValueToCopy = selectedWatchValue;
        showContextMenu = true;
        StateHasChanged();
    }

    void HideContextMenu()
    {
        showContextMenu = false;
        StateHasChanged();
    }
}
